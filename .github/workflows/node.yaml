on:
  workflow_call:
    inputs:
      node-version:
        required: false
        type: string
        default: '24.x'
jobs:
  tests:
    runs-on: ubuntu-latest
    outputs:
      unit: ${{ steps.scripts.outputs.ci-unit && 'true' || 'false' }}
      integration: ${{ steps.scripts.outputs.ci-integration && 'true' || 'false' }}
      coverage: ${{ steps.scripts.outputs.ci-coverage && 'true' || 'false' }}
      functional: ${{ steps.scripts.outputs.ci-functional && 'true' || 'false' }}
      audit: ${{ steps.scripts.outputs.ci-audit && 'true' || 'false' }}
      lint: ${{ steps.scripts.outputs.ci-lint && 'true' || 'false' }}
      deprecation: ${{ steps.scripts.outputs.ci-deprecation && 'true' || 'false' }}
    steps:
      - uses: actions/checkout@v4
      - name: Check package.json scripts
        id: scripts
        uses: zoexx/github-action-json-file-properties@1.0.6
        with:
          file_path: package.json
          prop_path: scripts
  unit-tests:
    needs: tests
    if: ${{ needs.tests.outputs.unit == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js ${{ inputs.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: 'npm'
      - run: npm ci
      - run: npm run build --if-present
      - run: npm run ci-unit
      - id: check-report
        run: |
          if [ -f ./coverage/junit.xml ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
      - name: Publish Test Results
        if: ${{ steps.check-report.outputs.exists == 'true' }}
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          files: |
            coverage/junit.xml
  coverage:
    needs: tests
    if: ${{ needs.tests.outputs.coverage == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js ${{ inputs.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: 'npm'
      - run: npm ci
      - run: npm run build --if-present
      - run: npm run ci-coverage
      - id: check-report
        run: |
          if [ -f ./coverage/report.json ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
      - uses: ArtiomTr/jest-coverage-report-action@v2
        if: ${{ steps.check-report.outputs.exists == 'true' }}
        id: coverage
        with:
          coverage-file: ./coverage/report.json
          base-coverage-file: ./coverage/report.json
          output: report-markdown
      - uses: marocchino/sticky-pull-request-comment@v2
        with:
          message: ${{ steps.coverage.outputs.report }}

  audit:
    needs: tests
    if: ${{ needs.tests.outputs.audit == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js ${{ inputs.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: 'npm'
      - run: npm ci
      - run: mkdir -p ./audit/results
      - run: npm run audit:check
      - name: Upload Audit Results
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: audit-results
          path: ./audit/auditResults.json

  lint:
    needs: tests
    if: ${{ needs.tests.outputs.lint == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js ${{ inputs.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: 'npm'
      - run: npm ci
      - run: npm run ci-lint

  deprecation:
    needs: tests
    if: ${{ needs.tests.outputs.deprecation == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js ${{ inputs.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: 'npm'
      - run: npm ci
      - run: npm run ci-deprecation
